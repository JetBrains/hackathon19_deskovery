<html lang="en">
<head>
    <title>Deskovery Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body, html {
            height: 100%;
            background-color: darkgrey
        }

        canvas {
            width: 96vh;
            height: 96vh;
            background-color: lightskyblue;
            margin: 2vh
        }
    </style>
</head>
<body style="">
<canvas id="mapcanvas" width="1000" height="1000"></canvas>
<script>

    function drawMap(bounds, mapArray) {
        let first = true;
        bounds.ctx.beginPath();
        bounds.ctx.strokeStyle = "#303030";
        for (d of mapArray) {
            let x = bounds.screenX(d.x);
            let y = bounds.screenY(d.y);
            if (first) {
                first = false;
                bounds.ctx.moveTo(x, y);
            } else {
                bounds.ctx.lineTo(x, y)
            }
        }
        bounds.ctx.stroke();
    }

    function drawDirections(bounds, mapArray) {
        let dist = bounds.diagonal / 15;
        for (d of mapArray) {
            let dx = dist * Math.cos(d.theta);
            let dy = dist * Math.sin(d.theta);
            bounds.ctx.beginPath();
            bounds.ctx.strokeStyle = "#FFFF00";
            bounds.ctx.moveTo(bounds.screenX(d.x), bounds.screenY(d.y));
            bounds.ctx.lineTo(bounds.screenX(d.x + dx), bounds.screenY(d.y + dy));
            bounds.ctx.stroke()
        }
    }

    function drawObstacles(bounds, obstacles) {
        let dist = bounds.diagonal / 100;
        for (obstacle of obstacles) {

            let dx = dist * Math.cos(obstacle.angle + Math.PI/2);
            let dy = dist * Math.sin(obstacle.angle + Math.PI/2);
            bounds.ctx.beginPath();
            bounds.ctx.strokeStyle = "#FF0000";

            bounds.ctx.moveTo(bounds.screenX(obstacle.x - dx),bounds.screenY( obstacle.y - dy));
            bounds.ctx.lineTo(bounds.screenX(obstacle.x + dx),bounds.screenY( obstacle.y + dy));
            bounds.ctx.stroke()
        }
    }

    function runMapData(mapArray) {
        let ctx = document.getElementById("mapcanvas").getContext("2d");
        let maxX = -1e99;
        let maxY = -1e99;
        let minX = 1e99;
        let minY = 1e99;
        let obstacles = [];
        for (d of mapArray) {
            maxX = Math.max(maxX, d.x);
            maxY = Math.max(maxY, d.y);
            minX = Math.min(minX, d.x);
            minY = Math.min(minY, d.y);
            if (d.dto >= 0) {
                d.theta = d.th / 180 * Math.PI;
                let obstacle = {
                    x: d.x + d.dto * Math.cos(d.theta),
                    y: d.y + d.dto * Math.sin(d.theta),
                    visX: d.x,
                    visY: d.y,
                    angle: d.theta
                };
                maxX = Math.max(maxX, obstacle.x);
                maxY = Math.max(maxY, obstacle.y);
                minX = Math.min(minX, obstacle.x);
                minY = Math.min(minY, obstacle.y);
                obstacles.push(obstacle);
            }
        }
        const bounds = {
            ctx: ctx,
            canvas: ctx.canvas,
            width: (maxX - minX) * 1.2,
            left: minX - (maxX - minX) / 10,
            height: (maxY - minY) * 1.2,
            top: maxY + (maxY - minY) / 10,
            screenX: function (x) {
                return this.canvas.width * (x - this.left) / this.width;
            },
            screenY: function (y) {
                return this.canvas.height * (this.top - y) / this.height;
            }
        };
        bounds.diagonal = Math.sqrt(bounds.width * bounds.width + bounds.height * bounds.height);

        drawMap(bounds, mapArray);
        drawDirections(bounds, mapArray);
        drawObstacles(bounds, obstacles);


    }

    var xmlhttp = new XMLHttpRequest();

    xmlhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
            var myObj = JSON.parse(this.responseText);
            runMapData(myObj);
        }
    };
    // xmlhttp.open("GET", "/map_data", true);
    xmlhttp.open("GET", "data.json", true);
    xmlhttp.send();
</script>
</body>
</html>